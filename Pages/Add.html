<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Items Master</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
body { background:#f1f5f9; font-family:Inter,system-ui,sans-serif; }
.card { background:#fff; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.08); }
label { font-weight:600; font-size:14px; color:#334155; }
input, select { outline:none; }
</style>
</head>

<body class="p-3 md:p-6">

<div class="max-w-7xl mx-auto card p-4 md:p-6">

<!-- HEADER -->
<div class="flex flex-col md:flex-row gap-3 md:justify-between mb-6">
  <input id="searchBox"
    placeholder="Search Description"
    onkeyup="applySearch()"
    class="border px-4 py-2 rounded-xl w-full md:w-72">

  <button onclick="openModal()"
    class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold w-full md:w-auto">
    + Add Item
  </button>
</div>

<!-- TABLE -->
<div class="overflow-x-auto border rounded-xl">
<table class="min-w-[900px] w-full text-sm">
<thead class="bg-slate-100">
<tr>
  <th class="p-2">Description</th>
  <th>HSN</th>
  <th>Price</th>
  <th>Pack</th>
  <th>GST%</th>
  <th>Stock</th>
  <th>Type</th>
  <th>ITC</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>
</div>

</div>

<!-- MODAL -->
<div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
<div class="bg-white rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-4 md:p-6">

<h2 id="modalTitle" class="text-xl font-bold mb-4">Add Item</h2>
<input type="hidden" id="editCode">

<div class="grid grid-cols-1 md:grid-cols-2 gap-4">

<div>
  <label>Description</label>
  <input id="desc" class="w-full border p-3 rounded-lg">
</div>

<div>
  <label>HSN Code</label>
  <select id="hsn" class="w-full border p-3 rounded-lg" onchange="onHSNChange()">
    <option value="">Select HSN</option>
  </select>
</div>

<div>
  <label>Unit Price</label>
  <input id="price" type="number" class="w-full border p-3 rounded-lg">
</div>

<div>
  <label>Unit Pack</label>
  <input id="pack" class="w-full border p-3 rounded-lg">
</div>

<div>
  <label>GST %</label>
  <input id="gst" type="number" readonly
         class="w-full border p-3 rounded-lg bg-slate-100">
</div>

<div>
  <label>Inventory Qty</label>
  <input id="qty" type="number" class="w-full border p-3 rounded-lg">
</div>

<div>
  <label>Goods / Services</label>
  <select id="gos" class="w-full border p-3 rounded-lg">
    <option value="Goods">Goods</option>
    <option value="Services">Services</option>
  </select>
</div>

<div>
  <label>ITC Eligible</label>
  <select id="itc" class="w-full border p-3 rounded-lg">
    <option value="No">No</option>
    <option value="Yes">Yes</option>
  </select>
</div>

</div>

<div class="flex justify-end gap-3 mt-6">
  <button onclick="closeModal()" class="px-6 py-3 border rounded-xl">
    Cancel
  </button>
  <button onclick="save()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold">
    Save
  </button>
</div>

</div>
</div>

<script>
/* ================= CONFIG ================= */
const API_URL =
'https://script.google.com/macros/s/AKfycbxJmkUyCK-R3IonDnmYQd48h1jh71XSzjWZV34DMysDoccgLk6b1-kvsZjrAhOSRtvk/exec';

const HSN_API =
'https://script.google.com/macros/s/AKfycbxllW6WXj7sJpoMChVyDOi46qwv_jSa8DQu3JeiAHcNATUZfMsOrJlCaHBVWqbKQMpR/exec';

/* ================= STATE ================= */
let ALL = [];
let HSN_MAP = {};

/* ================= API ================= */
function api(action, payload = {}) {
  return fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ action, ...payload })
  }).then(r => r.json());
}

/* ================= LOADERS ================= */
function loadHSN() {
  fetch(HSN_API)
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) {
        alert('HSN API error');
        return;
      }

      HSN_MAP = {};
      hsn.innerHTML = '<option value="">Select HSN</option>';

      data.forEach(r => {
        HSN_MAP[r.HSN] = r.GST_Rate;
        const opt = document.createElement('option');
        opt.value = r.HSN;
        opt.textContent = `${r.HSN} (${r.GST_Rate}%)`;
        hsn.appendChild(opt);
      });

      console.log('HSN Loaded', HSN_MAP);
    })
    .catch(e => {
      alert('HSN Load Failed');
      console.error(e);
    });
}

function load() {
  api('read').then(d => {
    ALL = Array.isArray(d) ? d : [];
    render(ALL);
  });
}

/* ================= UI ================= */
function render(data) {
  rows.innerHTML = data.length ? data.map(r => `
<tr class="border-t">
<td class="p-2">${r.Description}</td>
<td>${r.HSN}</td>
<td>${r.UnitPrice}</td>
<td>${r.Unit_Pack}</td>
<td>${r.GST_Rate}</td>
<td>${r.InventoryQty}</td>
<td>${r.GoodsOrService}</td>
<td>${r.ITC}</td>
<td>
  <button onclick='edit(${JSON.stringify(r)})' class="text-blue-600 font-bold">Edit</button>
  <button onclick='del("${r.ItemCode}")' class="text-red-600 font-bold ml-2">Del</button>
</td>
</tr>`).join('')
  : `<tr><td colspan="9" class="p-6 text-center text-slate-400">No records</td></tr>`;
}

function applySearch() {
  const q = searchBox.value.toLowerCase();
  render(!q ? ALL : ALL.filter(r => r.Description.toLowerCase().includes(q)));
}

function onHSNChange() {
  gst.value = hsn.value && HSN_MAP[hsn.value] ? HSN_MAP[hsn.value] : '';
}

/* ================= MODAL ================= */
function openModal() {
  modal.classList.replace('hidden', 'flex');
  modalTitle.innerText = 'Add Item';
  editCode.value = '';
  desc.value = price.value = pack.value = qty.value = '';
  hsn.value = '';
  gst.value = '';
  gos.value = 'Goods';
  itc.value = 'No';
}

function closeModal() {
  modal.classList.replace('flex', 'hidden');
}

function edit(r) {
  openModal();
  modalTitle.innerText = 'Edit Item';
  editCode.value = r.ItemCode;
  desc.value = r.Description;
  hsn.value = r.HSN;
  onHSNChange();
  price.value = r.UnitPrice;
  pack.value = r.Unit_Pack;
  qty.value = r.InventoryQty;
  gos.value = r.GoodsOrService;
  itc.value = r.ITC;
}

/* ================= SAVE / DELETE ================= */
function save() {
  if (!hsn.value) {
    alert('Please select HSN');
    return;
  }

  const data = {
    Description: desc.value.trim(),
    HSN: hsn.value,
    UnitPrice: price.value,
    Unit_Pack: pack.value.trim(),
    GST_Rate: gst.value,
    InventoryQty: qty.value || 0,
    GoodsOrService: gos.value,
    ITC: itc.value
  };

  const req = editCode.value
    ? api('update', { data: { ...data, ItemCode: editCode.value } })
    : api('create', { data });

  req.then(() => { closeModal(); load(); });
}

function del(code) {
  if (!confirm('Delete item?')) return;
  api('delete', { code }).then(load);
}

/* ================= INIT ================= */
function init() {
  loadHSN();
  load();
}
init();
</script>

</body>
</html>
